/*
 weather_radio 2017-01-16 
*/
var weather_data={},artist_data=[],user_zip,user_city,user_state,chill_genres=["acoustic","ambient","chill","singer-songwriter","songwriter"],rock_genres=["alt-rock","alternative","emo","garage","grunge","indie","indie-pop","psych-rock","punk","punk-rock","rock","rock-n-roll","rockabilly"],metal_genres=["black-metal","death-metal","goth","grindcore","hard-rock","hardcore","heavy-metal","metal","metal-misc","metalcore"],country_folk_genres=["bluegrass","country","folk","honky-tonk","singer-songwriter","songwriter"],hiphop_rnb_genres=["breakbeat","hip-hop","funk","groove","r-n-b","soul"],electronic_genres=["chicago-house","club","dance","deep-house","detroit-techno","drum-and-bass","dubstep","edm","electro","electronic","house","post-dubstep","progressive-house","techno","trance","trip-hop"],world_genres=["bossanova","brazil","dancehall","latin","reggae","reggaeton","salsa","samba","world-music","afrobeat"],observableWeather=[{name:"Funnel Cloud",valence:.01},{name:"Heavy Thunderstorms with Hail",valence:.02},{name:"Light Thunderstorms with Hail",valence:.03},{name:"Light Hail",valence:.04},{name:"Heavy Hail",valence:.05},{name:"Heavy Thunderstorms and Ice Pellets",valence:.06},{name:"Heavy Thunderstorms and Rain",valence:.08},{name:"Light Thunderstorms and Rain",valence:.09},{name:"Heavy Thunderstorm",valence:.1},{name:"Light Thunderstorms with Small Hail",valence:.11},{name:"Heavy Thunderstorms with Small Hail",valence:.12},{name:"Light Thunderstorms and Snow",valence:.13},{name:"Heavy Thunderstorms and Snow",valence:.14},{name:"Heavy Freezing Rain",valence:.15},{name:"Light Freezing Rain",valence:.16},{name:"Light Ice Crystals",valence:.17},{name:"Heavy Ice Crystals",valence:.18},{name:"Light  Ice Pellets",valence:.19},{name:"Heavy Ice Pellets",valence:.2},{name:"Heavy Freezing Drizzle",valence:.21},{name:"Light Snow Blowing Snow Mist",valence:.22},{name:"Heavy Snow Blowing Snow Mist",valence:.23},{name:"Light Ice Pellet Showers",valence:.24},{name:"Heavy Ice Pellet Showers",valence:.25},{name:"Light Hail Showers",valence:.26},{name:"Heavy Hail Showers",valence:.27},{name:"Light Small Hail Showers",valence:.28},{name:"Heavy Small Hail Showers",valence:.29},{name:"Heavy Freezing Fog",valence:.3},{name:"Light Thunderstorm",valence:.31},{name:"Small Hail",valence:.32},{name:"Light Freezing Drizzle",valence:.33},{name:"Light Freezing Fog",valence:.34},{name:"Light Blowing Snow",valence:.35},{name:"Rain",valence:.38},{name:"Heavy Rain",valence:.375},{name:"Heavy Rain Showers",valence:.39},{name:"Heavy Rain Mist",valence:.405},{name:"Heavy Mist",valence:.42},{name:"Heavy Fog",valence:.435},{name:"Heavy Fog Patches",valence:.45},{name:"Heavy Drizzle",valence:.465},{name:"Light Rain",valence:.48},{name:"Light Drizzle",valence:.495},{name:"Snow",valence:.5},{name:"Heavy Snow",valence:.51},{name:"Heavy Snow Showers",valence:.525},{name:"Light Rain Mist",valence:.54},{name:"Light Rain Showers",valence:.555},{name:"Light Snow Showers",valence:.57},{name:"Light Fog",valence:.585},{name:"Shallow Fog",valence:.6},{name:"Patches of Fog",valence:.63},{name:"Light Fog Patches",valence:.645},{name:"Light Mist",valence:.66},{name:"Overcast",valence:.67},{name:"Light Snow",valence:.73},{name:"Mostly Cloudy",valence:.79},{name:"Partly Cloudy",valence:.85},{name:"Scattered Clouds",valence:.91},{name:"Clear",valence:.99}],seed_valence,seed_artists=[],seed_genres=[],track_dance,track_energy,user_id,playlist_id,playlist_tracks="",playlist_array=[],playlist_url,randomNumber;!function(){function a(){for(var a,b={},c=/([^&;=]+)=?([^&;]*)/g,d=window.location.hash.substring(1);a=c.exec(d);)b[a[1]]=decodeURIComponent(a[2]);return b}$("#player").hide();var b=a(),c=b.access_token,d=(b.refresh_token,b.error);d?swal({title:"There was an error during the authentication",type:"warning",showCancelButton:!1,closeOnConfirm:!0},function(){window.location.href="https://weather-radio.herokuapp.com/"}):c?$.ajax({url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+c},success:function(a){user_id=a.id,$("#login").hide(),$("#loggedin").show()}}):($("#login").show(),$("#loggedin").hide()),document.getElementById("obtain-playlist").addEventListener("click",function(){e()}),$("#new-playlist").on("click",function(){$("#player").hide(),$("#makePlaylistDiv").show()});var e=function(){return(user_zip=document.getElementById("zipcode").value)?user_zip.length<5?void swal("Please enter a valid zipcode to proceed"):void $.ajax({type:"GET",dataType:"json",url:"https://ZiptasticAPI.com/"+user_zip,success:function(a){console.log(a),user_city=a.city,user_state=a.state,console.log(user_city),console.log(user_state),g()}}):void swal("Please enter a zipcode to proceed")},f=function(){console.log("access",c),$.ajax({type:"GET",url:"https://api.spotify.com/v1/me/top/artists",dataType:"json",headers:{Authorization:"Bearer "+c},success:function(a){console.log("back from spotify with: ",a);for(var b=0;b<a.items.length;b++){var c={name:a.items[b].name,genres:a.items[b].genres,artist_uri:a.items[b].uri};artist_data.push(c)}console.log(artist_data),h(),m()},error:function(a){console.log("Error retrieving spotify API ",a)}})},g=function(){$.ajax({type:"GET",url:"http://api.wunderground.com/api/b67101dd22166f78/conditions/q/"+user_state+"/"+user_city+".json",dataType:"json",success:function(a){console.log("back with",a);var b=a.current_observation.feelslike_f;if("undefined"!=b){var c=a.current_observation.weather;if("undefined"!=c){var d=a.current_observation.wind_mph;"undefined"!=d&&(weather_data.current_temp=Math.floor(b),weather_data.current_conditions=c,weather_data.current_wind=d,console.log(b,c,d),console.log(weather_data),j(),k(),i(),f())}}}})},h=function(){for(var a=0;a<artist_data.length;a++)for(var b=0;b<artist_data[a].genres.length;b++)for(var c=0;c<electronic_genres.length;c++)electronic_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+electronic_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),chill_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+chill_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),rock_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+rock_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),metal_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+metal_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),country_folk_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+country_folk_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),hiphop_rnb_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+hiphop_rnb_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b)),world_genres[c]==artist_data[a].genres[b]&&(console.log("it's a match: "+world_genres[c]+" & "+artist_data[a].genres[b]+" Artist: "+artist_data[a].name),l(a,b));console.log(seed_artists,seed_genres),jQuery.unique(seed_genres),console.log(seed_genres)},i=function(){for(var a=0;a<observableWeather.length;a++)observableWeather[a].name==weather_data.current_conditions&&(console.log("in the if"),seed_valence=observableWeather[a].valence,console.log(seed_valence))},j=function(){var a=weather_data.current_temp;return a>-50&&a<=0?track_energy=0:a>0&&a<=10||a>50&&a<=60?track_energy=.2:a>10&&a<=20||a>60&&a<=70?track_energy=.4:a>20&&a<=30||a>70&&a<=80?track_energy=.6:a>30&&a<=40||a>80&&a<=90?track_energy=.8:(a>40&&a<=50||a>90&&a<=120)&&(track_energy=1),console.log(track_energy),track_energy},k=function(){var a=weather_data.current_wind;return a>=0&&a<=5?track_dance=0:a>5&&a<=10?track_dance=.2:a>10&&a<=15?track_dance=.4:a>15&&a<=20?track_dance=.6:a>20&&a<=30?track_dance=.8:a>30&&(track_dance=1),console.log(track_dance),track_dance},l=function(a,b){artistSeedId=artist_data[a].artist_uri.substring(15),seed_artists.push(artistSeedId),seed_genres.push(artist_data[a].genres[b])},m=function(){for(var a="https://api.spotify.com/v1/recommendations/?seed_artists=",b=0;b<3;b++)n(0,seed_artists.length),console.log(randomNumber),a+=seed_artists[randomNumber],b<2&&(a+=",");a+="&seed_genres=";for(var d=0;d<2;d++)n(0,seed_genres.length),console.log(randomNumber),a+=seed_genres[randomNumber],d<1&&(a+=",");a+="&target_energy=",a+=track_energy,a+="&target_danceability=",a+=track_dance,a+="&target_valence=",a+=seed_valence,a+="&limit=50",console.log(a),$.ajax({type:"GET",url:a,dataType:"json",headers:{Authorization:"Bearer "+c},success:function(a){console.log(a),console.log(a.tracks);for(var b=0;b<a.tracks.length;b++)console.log(a.tracks[b].artists[0].name+" "+a.tracks[b].name),console.log(a.tracks[b].uri),playlist_array.push(a.tracks[b].uri);for(jQuery.unique(playlist_array),playlist_tracks="",b=0;b<playlist_array.length;b++)playlist_tracks+=b==playlist_array.length-1?playlist_array[b]:playlist_array[b]+",";console.log(playlist_tracks),$.ajax({type:"POST",url:"https://api.spotify.com/v1/users/"+user_id+"/playlists",dataType:"json",data:'{"name":"'+user_city+"- "+weather_data.current_temp+" degrees and "+weather_data.current_conditions+': A Weather Radio Playlist", "public":true}',headers:{Authorization:"Bearer "+c,"Content-Type":"application/json"},success:function(a){console.log("Great Success",a),playlist_id=a.id,playlist_url=a.uri,$.ajax({type:"POST",url:"https://api.spotify.com/v1/users/"+user_id+"/playlists/"+playlist_id+"/tracks?uris="+playlist_tracks,dataType:"json",headers:{Authorization:"Bearer "+c,"Content-Type":"application/json"},success:function(a){console.log("Success:",a);var b="https://embed.spotify.com/?uri="+playlist_url;console.log(b),document.getElementById("spotifyPlayer").src=b,$("#makePlaylistDiv").hide(),$("#player").show()},error:function(a){console.log("err: ",a)}})},error:function(a){console.log("err: ",a)}})},error:function(a){console.log("err: ",a)}})},n=function(a,b){randomNumber=Math.floor(Math.random()*(b-a)+a)};Raven.config("https://b5ce00ca920843f58b5c04fa17eb36e6@sentry.io/129792").install()}();